name: Build iOS

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build-ios-app:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'  # buildozer doesn't support Python 3.12+

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install kivy-ios

    - name: Set up iOS build environment
      run: |
        # Check if ios directory and buildozer.spec exist
        if [ ! -d ios ]; then
          echo "ERROR: ios directory not found"
          exit 1
        fi
        if [ ! -f ios/buildozer.spec ]; then
          echo "ERROR: ios/buildozer.spec not found"
          exit 1
        fi
        cd ios
        # Initialize kivy-ios
        kivy-ios init

        # Configure for SmartOS
        sed -i '' 's/title = .*/title = SmartOS/' buildozer.spec
        sed -i '' 's/package.name = .*/package.name = smartos/' buildozer.spec
        sed -i '' 's/package.domain = .*/package.domain = com.ledokoz.smartos/' buildozer.spec
        sed -i '' 's/source.dir = .*/source.dir = ../engine/' buildozer.spec

    - name: Build iOS app
      run: |
        cd ios
        # Build iOS app
        kivy-ios build SmartOS

    - name: Create IPA
      run: |
        cd ios
        # Create IPA file for distribution
        mkdir -p dist
        xcodebuild -project SmartOS-ios.xcodeproj -scheme SmartOS -configuration Release -archivePath dist/SmartOS.xcarchive archive
        xcodebuild -exportArchive -archivePath dist/SmartOS.xcarchive -exportPath dist -exportOptionsPlist exportOptions.plist

    - name: Upload iOS build
      uses: actions/upload-artifact@v4
      with:
        name: smartos-ios
        path: ios/dist/SmartOS.ipa

  build-ios-simulator:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'  # buildozer doesn't support Python 3.12+

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install kivy-ios

    - name: Build iOS Simulator app
      run: |
        cd ios
        kivy-ios build SmartOS --simulator

    - name: Upload iOS Simulator build
      uses: actions/upload-artifact@v4
      with:
        name: smartos-ios-simulator
        path: ios/build/SmartOS.app

  test-ios:
    runs-on: macos-latest
    needs: build-ios-simulator

    steps:
    - uses: actions/checkout@v4

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Download Simulator build
      uses: actions/download-artifact@v4
      with:
        name: smartos-ios-simulator
        path: ios/build/

    - name: Run iOS tests
      run: |
        cd ios
        # Run tests on simulator if available
        xcodebuild test -project SmartOS-ios.xcodeproj -scheme SmartOS -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest'

  deploy-testflight:
    runs-on: macos-latest
    needs: [build-ios-app, test-ios]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4

    - name: Download iOS IPA
      uses: actions/download-artifact@v4
      with:
        name: smartos-ios
        path: ios/dist/

    - name: Deploy to TestFlight
      run: |
        cd ios
        # Upload to TestFlight using fastlane or xcodebuild
        xcodebuild -exportArchive -archivePath dist/SmartOS.xcarchive -exportPath dist -exportOptionsPlist exportOptions.plist
        # Upload to App Store Connect
        xcrun altool --upload-app -f dist/SmartOS.ipa -u ${{ secrets.APPLE_ID }} -p ${{ secrets.APPLE_APP_PASSWORD }}

      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
