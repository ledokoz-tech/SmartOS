name: Build Linux

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build-linux-appimage:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libffi-dev libssl-dev build-essential fuse libfuse2 python3-pip

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r engine/requirements.txt
        pip install pyinstaller staticx

    - name: Build AppImage
      run: |
        cd engine
        pyinstaller --onefile --name smartos homeassistant/__main__.py

        # Create AppImage
        wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage

        # Create AppDir structure
        mkdir -p AppDir/usr/bin AppDir/usr/share/smartos
        cp dist/smartos AppDir/usr/bin/
        cp ../core/branding/smartos_icon.png AppDir/smartos.png 2>/dev/null || echo "Icon not found"
        cp ../scripts/linux/smartos.desktop AppDir/ 2>/dev/null || echo "Desktop file not found"
        cp ../scripts/linux/AppRun AppDir/
        cp -r ../core AppDir/usr/share/

        # Create AppImage
        ./appimagetool-x86_64.AppImage AppDir SmartOS-x86_64.AppImage

    - name: Upload Linux AppImage
      uses: actions/upload-artifact@v4
      with:
        name: smartos-linux-appimage
        path: engine/SmartOS-x86_64.AppImage

  build-linux-deb:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential debhelper dh-python python3-all python3-setuptools

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    - name: Build DEB package
      run: |
        # Create basic DEB structure if build script exists
        if [ -f scripts/linux/build-deb.sh ]; then
          cd scripts/linux
          chmod +x build-deb.sh
          ./build-deb.sh
        else
          echo "DEB build script not found, skipping DEB build"
        fi

    - name: Upload DEB package
      uses: actions/upload-artifact@v4
      with:
        name: smartos-linux-deb
        path: scripts/linux/smartos_*.deb

  build-linux-snap:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Snapcraft
      run: |
        sudo snap install snapcraft --classic

    - name: Build Snap package
      run: |
        # Check if snapcraft.yaml exists
        if [ -f scripts/linux/snapcraft.yaml ]; then
          cd scripts/linux
          snapcraft --use-lxd
        else
          echo "snapcraft.yaml not found, skipping Snap build"
        fi

    - name: Upload Snap package
      uses: actions/upload-artifact@v4
      with:
        name: smartos-linux-snap
        path: scripts/linux/*.snap

  build-linux-flatpak:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Flatpak
      run: |
        sudo apt-get update
        sudo apt-get install -y flatpak flatpak-builder

    - name: Build Flatpak
      run: |
        # Check if flatpak manifest exists
        if [ -f scripts/linux/smartos.yml ]; then
          cd scripts/linux
          flatpak-builder --force-clean build-dir smartos.yml
        else
          echo "Flatpak manifest not found, skipping Flatpak build"
        fi

    - name: Upload Flatpak bundle
      uses: actions/upload-artifact@v4
      with:
        name: smartos-linux-flatpak
        path: scripts/linux/smartos.flatpak

  build-linux-arm64:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build ARM64 Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/Dockerfile.arm64
        platforms: linux/arm64
        push: false
        tags: smartos:arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max
        load: true

    - name: Extract ARM64 binary
      run: |
        docker create --name temp smartos:arm64
        docker cp temp:/home/smartos/engine/dist/smartos engine/dist/smartos-arm64
        docker rm temp

    - name: Upload ARM64 build
      uses: actions/upload-artifact@v4
      with:
        name: smartos-linux-arm64
        path: engine/dist/smartos-arm64
